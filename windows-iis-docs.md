# Generating a certificate for Windows IIS

## Install mkcert

Follow any install instructions from the `mkcert` docs: https://github.com/FiloSottile/mkcert#windows

> Example: `choco install mkcert`	

## Create a local Certificate Authority (CA)

- Open an elevated (e.g. Run as Administrator) command line
- Run `mkcert -install`
	- Expected result:
		- Using the local CA at "C:\Users\[Username]\AppData\Local\mkcert" ✨
		- The local CA is now installed in the system trust store! ⚡️
		- The local CA is now installed in Java's trust store! ☕
	> `[Username]` is _your_ local username
	
## Create a certificate

* Open an elevated (e.g. Run as Administrator) command line
* Run `mkcert *.local.net`
	> `*.local.net` should be replaced with whatever domain is required for your local site. This example uses a wildcard, but you can use something more specific, e.g. `localhost` or `mylocaldomain.dev` 
	* Expected result:
		* Using the local CA at "C:\Users\[Username]\AppData\Local\mkcert" ✨
		* Created a new certificate valid for the following names 📜
			* "*.local.net"
		* The certificate is at "./_wildcard.local.net.pem" and the key at "./_wildcard.local.net-key.pem" ✅
	> NOTE: `[Username]` is _your_ local username.
		
* There should now be two `.pem` files in the folder where you invoked the `mkcert` command. One file is the key and will be suffixed with `-key.pem`. The other file is the certificate and will just have a `.pem` extension.
  > NOTE: the `.pem` files will be named according to the domain you specified when running `mkcert`. This example uses `*.local.net`, so the certificate/key names are `_wildcard.local.net.pem` and `_wildcard.local.net-key.pem`. 

## Convert `.pem` to `.pfx`

IIS requires certificates to be in `.pfx` format. You can use OpenSSL to convert the mkcert-generated `.pem` files to `.pfx`.

### Install OpenSSL

OpenSSL is by default only distributed as source code. You can download Windows binaries from this site: https://slproweb.com/products/Win32OpenSSL.html 

Or use Chocolatey:
`choco install openssl.light`

### Convert

* Open an elevated (e.g. Run as Administrator) command line
* Run `openssl pkcs12 -export -out _wildcard.local.net.pfx -inkey _wildcard.local.net-key.pem -in _wildcard.local.net.pem -certfile C:\Users\[Username]\AppData\Local\mkcert\rootCA.pem`
  - > NOTE: There are 4 parameters you need to specify in the command above:
    1. `-out`: the name of/path to the `.pfx` file that will be generated.
    1. `-inkey`: the name of/path to the `-key.pem` _key_ file that was generated by mkcert.
    1. `-in`: the name of/path to the `.pem` _certificate_ file that was generated by mkcert.
    1. `-certfile`: the absolute path to the `rootCA.pem` file that mkcert generated during the `mkcert -install` command.
  - You will be prompted to provide a password (and confirm it). This password will be used when importing into IIS.

## Import certificate to IIS

* Open IIS
* Click on the server you wish to add the certificate to.
	> NOTE: don't select a site, select a server (e.g. your local machine)
* Double-click the `Server Certificates` icon in the main IIS pane.
* Click `Import...` in the `Actions` menu on the right.
* In the `Import Certificate` dialog
	- Browse for and select the `.pfx` you created earlier
	- Enter the password you specified when creating the `.pfx`
	- Select `Personal` in the `Select Certificate Store` dropdown
	- For the `Allow this certificate to be exported` option - that's up to you, the certificate should work regardless of what you choose.
* You should now see a certificate with an empty `Name` field in the certificates list
	- The `Issued To` value of the certificate should be something like this: `OU=MACHINENAME\username@MACHINENAME, O=mkcert development certificate`
  > `MACHINENAME` will be your local machine name, `username` will be your local username.
* Select an IIS site that you'd like to use the certificate with.
* Click `Bindings...` in the `Actions` menu on the right
* Click `Add...` to add a binding with the following:
	- Type: `https`
	- Hostname: provide a hostname for the binding, you will need to use a hostname that matches the certificate.
	- SSL certificate: select the certificate identified above, e.g. `OU=MACHINENAME\username@MACHINENAME, O=mkcert development certificate`
* After clicking OK, you should now see a `https` binding for your hostname in the `Site Bindings` list.

Browse to your site in a browser, e.g. https://my-site.local.net
	